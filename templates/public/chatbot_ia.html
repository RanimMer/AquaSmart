<div id="chatbot-button">ðŸ’¬</div>

<div id="chatbot-window">
    <div id="chatbot-header">
        AquaBot
        <span id="close-chatbot">âœ–</span>
    </div>

    <div id="chatbot-content"></div>

    <div id="chatbot-input-wrapper">
        <!-- Bouton + pour ajouter une image -->
        <button id="add-image-btn">+</button>
        <!-- Input texte principal -->
        <input type="text" id="message" placeholder="Ã‰crire un message...">
        <button id="send-btn">Envoyer</button>
        <!-- Input image cachÃ© -->
        <input type="file" id="image" accept="image/*" style="display:none;">
    </div>
</div>

<style>
#chatbot-button {
    position: fixed; bottom: 25px; right: 25px; 
    background-color: #78c800; color: white; 
    width: 60px; height: 60px; border-radius: 50%; 
    display: flex; justify-content: center; align-items: center; 
    font-size: 28px; cursor: pointer; z-index: 9999; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

#chatbot-window {
    position: fixed; bottom: 100px; right: 25px; 
    width: 380px; height: 450px; background: white; 
    border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
    display: none; flex-direction: column; overflow: hidden; z-index: 99999;
}

#chatbot-header {
    background: #78c800; color: white; padding: 10px; 
    text-align: center; position: relative; font-weight: bold;
}

#close-chatbot {
    position: absolute; right: 10px; cursor: pointer;
}

#chatbot-content {
    flex: 1; padding: 10px; overflow-y: auto; background: #f7f7f7;
}

#chatbot-input-wrapper {
    display: flex; border-top: 1px solid #ccc; padding: 5px; gap:5px; align-items: center;
}

#chatbot-input-wrapper input[type="text"] {
    flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc;
}

#chatbot-input-wrapper button {
    background: #78c800; color: white; border: none; 
    padding: 8px 12px; cursor: pointer; border-radius: 5px;
}

.user-message { text-align: right; margin: 5px; }
.bot-message { text-align: left; margin: 5px; }
</style>

<script>
const chatbotButton = document.getElementById("chatbot-button");
const chatbotWindow = document.getElementById("chatbot-window");
const closeChatbot = document.getElementById("close-chatbot");
const sendBtn = document.getElementById("send-btn");
const addImageBtn = document.getElementById("add-image-btn");
const imageInput = document.getElementById("image");
const messageInput = document.getElementById("message");
const chatContent = document.getElementById("chatbot-content");

// Afficher / cacher le chatbot
chatbotButton.addEventListener("click", () => { chatbotWindow.style.display = "flex"; });
closeChatbot.addEventListener("click", () => { chatbotWindow.style.display = "none"; });

// Ouvrir le file picker quand on clique sur +
addImageBtn.addEventListener("click", () => { imageInput.click(); });

// Envoyer le message
sendBtn.addEventListener("click", sendMessage);

// Fonction pour envoyer question + image
function sendMessage() {
    const msg = messageInput.value.trim();
    const imageFile = imageInput.files[0];

    if (!msg && !imageFile) return;

    // Afficher message utilisateur
    if (msg) chatContent.innerHTML += `<div class="user-message"><b>Vous :</b> ${msg}</div>`;
    if (imageFile) chatContent.innerHTML += `<div class="user-message"><b>Vous avez envoyÃ© une image</b></div>`;

    // RÃ©initialiser inputs
    messageInput.value = "";
    imageInput.value = "";

    // PrÃ©parer FormData
    let formData = new FormData();
    formData.append("question", msg);
    if (imageFile) formData.append("image", imageFile);

    fetch("/api/chatbot/", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
            if (data.answer) chatContent.innerHTML += `<div class="bot-message"><b>Bot :</b> ${data.answer}</div>`;
            else if (data.error) chatContent.innerHTML += `<div class="bot-message" style="color:red;"><b>Erreur :</b> ${data.error}</div>`;
            chatContent.scrollTop = chatContent.scrollHeight;
        })
        .catch(err => {
            chatContent.innerHTML += `<div class="bot-message" style="color:red;"><b>Erreur :</b> ${err}</div>`;
            chatContent.scrollTop = chatContent.scrollHeight;
        });
}
</script>
